<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV Preview</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cv_styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="preview-container">
        <div class="preview-header">
            <h1>Preview Your CV</h1>
            <div class="preview-actions">
                <button onclick="window.history.back()" class="secondary-btn"><i class="fas fa-arrow-left"></i> Edit CV</button>
                <button onclick="generatePDF()" class="primary-btn"><i class="fas fa-download"></i> Download PDF</button>
                <button onclick="downloadAllTemplates()" class="secondary-btn"><i class="fas fa-download"></i> Download All Templates</button>
            </div>
        </div>

        <!-- Template Selector -->
        <div class="template-selector">
            <h3><i class="fas fa-palette"></i> Choose Template</h3>
            <div class="template-grid">
                <div class="template-card active" data-template="modern" onclick="switchTemplate('modern')">
                    <div class="template-preview template-modern">
                        <div class="preview-header-bar gradient"></div>
                        <div class="preview-lines">
                            <div class="line"></div>
                            <div class="line"></div>
                            <div class="line"></div>
                        </div>
                    </div>
                    <p>Modern</p>
                </div>
                
                <div class="template-card" data-template="classic" onclick="switchTemplate('classic')">
                    <div class="template-preview template-classic">
                        <div class="preview-header-bar classic"></div>
                        <div class="preview-lines">
                            <div class="line"></div>
                            <div class="line"></div>
                            <div class="line"></div>
                        </div>
                    </div>
                    <p>Classic</p>
                </div>
                
                <div class="template-card" data-template="minimal" onclick="switchTemplate('minimal')">
                    <div class="template-preview template-minimal">
                        <div class="preview-header-bar minimal"></div>
                        <div class="preview-lines">
                            <div class="line"></div>
                            <div class="line"></div>
                            <div class="line"></div>
                        </div>
                    </div>
                    <p>Minimal</p>
                </div>
                
                <div class="template-card" data-template="professional" onclick="switchTemplate('professional')">
                    <div class="template-preview template-professional">
                        <div class="preview-header-bar professional"></div>
                        <div class="preview-lines">
                            <div class="line"></div>
                            <div class="line"></div>
                            <div class="line"></div>
                        </div>
                    </div>
                    <p>Professional</p>
                </div>
                
                <div class="template-card" data-template="ats" onclick="switchTemplate('ats')">
                    <div class="template-preview template-ats">
                        <div class="preview-header-bar ats"></div>
                        <div class="preview-lines">
                            <div class="line"></div>
                            <div class="line"></div>
                            <div class="line"></div>
                        </div>
                    </div>
                    <p>ATS-Friendly</p>
                </div>
            </div>
        </div>

        <!-- CV Preview Display -->
        <div class="cv-preview-wrapper">
            <div class="cv-document template-modern" id="cvDocument">
                <!-- Header Section -->
<div class="cv-header">
    {% if cv_data.personal_info.get('photo_url') %}
    <div class="cv-photo-container">
        <img src="{{ cv_data.personal_info.photo_url }}" alt="Profile Photo" class="cv-photo">
    </div>
    {% endif %}
    
    <div class="cv-header-content">
        <h1 class="cv-name">{{ cv_data.personal_info.name }}</h1>
        <h2 class="cv-title">{{ cv_data.personal_info.title }}</h2>
        
        <div class="cv-contact">
            <span><i class="fas fa-envelope"></i> {{ cv_data.personal_info.email }}</span>
            <span><i class="fas fa-phone"></i> {{ cv_data.personal_info.phone }}</span>
            {% if cv_data.personal_info.address.city %}
            <span><i class="fas fa-map-marker-alt"></i> {{ cv_data.personal_info.address.city }}{% if cv_data.personal_info.address.country %}, {{ cv_data.personal_info.address.country }}{% endif %}</span>
            {% endif %}
            {% if cv_data.personal_info.linkedin %}
            <span><i class="fab fa-linkedin"></i> <a href="{{ cv_data.personal_info.linkedin }}" target="_blank">LinkedIn</a></span>
            {% endif %}
            {% if cv_data.personal_info.website %}
            <span><i class="fas fa-globe"></i> <a href="{{ cv_data.personal_info.website }}" target="_blank">Website</a></span>
            {% endif %}
        </div>
    </div>
</div>

                <!-- Professional Summary -->
                {% if cv_data.professional_summary %}
                <div class="cv-section">
                    <h3 class="section-title">Professional Summary</h3>
                    <p class="summary-text">{{ cv_data.professional_summary }}</p>
                </div>
                {% endif %}

                <!-- Work Experience -->
                {% if cv_data.work_experience %}
                <div class="cv-section">
                    <h3 class="section-title">Work Experience</h3>
                    {% for job in cv_data.work_experience %}
                    <div class="experience-item">
                        <div class="item-header">
                            <div>
                                <h4 class="item-title">{{ job.job_title }}</h4>
                                <p class="item-subtitle">{{ job.company }}{% if job.location %} • {{ job.location }}{% endif %}</p>
                            </div>
                            <div class="item-date">
                                {{ job.start_date }} - {% if job.current %}Present{% else %}{{ job.end_date }}{% endif %}
                            </div>
                        </div>
                        {% if job.responsibilities %}
                        <ul class="responsibilities-list">
                            {% for responsibility in job.responsibilities %}
                            {% if responsibility %}
                            <li>{{ responsibility }}</li>
                            {% endif %}
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Education -->
                {% if cv_data.education %}
                <div class="cv-section">
                    <h3 class="section-title">Education</h3>
                    {% for edu in cv_data.education %}
                    <div class="education-item">
                        <div class="item-header">
                            <div>
                                <h4 class="item-title">{{ edu.degree }}{% if edu.field_of_study %} in {{ edu.field_of_study }}{% endif %}</h4>
                                <p class="item-subtitle">{{ edu.institution }}{% if edu.location %} • {{ edu.location }}{% endif %}</p>
                            </div>
                            <div class="item-date">
                                {% if edu.start_date %}{{ edu.start_date }} - {% endif %}{{ edu.end_date }}
                            </div>
                        </div>
                        {% if edu.gpa %}
                        <p class="gpa">GPA: {{ edu.gpa }}</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Skills -->
                {% if cv_data.skills %}
                <div class="cv-section">
                    <h3 class="section-title">Skills</h3>
                    {% if cv_data.skills.technical %}
                    <div class="skills-group">
                        <strong>Technical:</strong>
                        <div class="skills-list">
                            {% for skill in cv_data.skills.technical %}
                            {% if skill %}
                            <span class="skill-tag">{{ skill }}</span>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    {% if cv_data.skills.soft %}
                    <div class="skills-group">
                        <strong>Soft Skills:</strong>
                        <div class="skills-list">
                            {% for skill in cv_data.skills.soft %}
                            {% if skill %}
                            <span class="skill-tag">{{ skill }}</span>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Certifications -->
                {% if cv_data.certifications %}
                <div class="cv-section">
                    <h3 class="section-title">Certifications</h3>
                    {% for cert in cv_data.certifications %}
                    {% if cert.name %}
                    <div class="certification-item">
                        <div class="item-header">
                            <div>
                                <h4 class="item-title">{{ cert.name }}</h4>
                                <p class="item-subtitle">{{ cert.issuing_organization }}</p>
                            </div>
                            <div class="item-date">{{ cert.date_obtained }}</div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Floating Action Buttons (Always Visible) -->
    <div class="floating-actions">
        <button onclick="window.history.back()" class="floating-btn" title="Go Back">
            <i class="fas fa-arrow-left"></i>
        </button>
        <button onclick="generatePDF()" class="floating-btn" title="Download PDF">
            <i class="fas fa-download"></i>
        </button>
    </div>

    <script>
        // Store CV data for PDF generation
        const cvData = {{ cv_data | tojson | safe }};
        let selectedTemplate = 'modern'; // Default template

        // Switch template
        function switchTemplate(template) {
            selectedTemplate = template;
            
            // Update CV document class
            const cvDoc = document.getElementById('cvDocument');
            cvDoc.className = `cv-document template-${template}`;
            
            // Update active card
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('active');
            });
            document.querySelector(`[data-template="${template}"]`).classList.add('active');
            
            // Save preference to session
            sessionStorage.setItem('selectedTemplate', template);
        }
        
        // Load saved template preference
        window.addEventListener('DOMContentLoaded', () => {
            const savedTemplate = sessionStorage.getItem('selectedTemplate');
            if (savedTemplate) {
                switchTemplate(savedTemplate);
            }
        });

        function generatePDF() {
            // Show loading state - detect which button was clicked
            const button = event.target.closest('button');
            const originalHTML = button.innerHTML;
            button.disabled = true;
            
            // Check if it's the floating button (just icon) or header button (has text)
            if (button.classList.contains('floating-btn')) {
                // Floating button - just replace icon
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            } else {
                // Header button - show text with spinner
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            }
            
            fetch('/generate-pdf', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    cv_data: cvData,
                    template: selectedTemplate
                })
            })
            .then(response => response.blob())
            .then(blob => {
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `CV_${cvData.personal_info.name.replace(/ /g, '_')}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
                
                // Restore button state
                button.disabled = false;
                button.innerHTML = originalHTML;
            })
            .catch(error => {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF. Please try again.');
                
                // Restore button state
                button.disabled = false;
                button.innerHTML = originalHTML;
            });
        }
        async function downloadAllTemplates() {
    const button = event.target.closest('button');
    const originalHTML = button.innerHTML;
    button.disabled = true;
    
    const templates = [
        { id: 'modern', name: 'Modern' },
        { id: 'classic', name: 'Classic' },
        { id: 'minimal', name: 'Minimal' },
        { id: 'professional', name: 'Professional' },
        { id: 'ats', name: 'ATS-Friendly' }
    ];
    
    for (let i = 0; i < templates.length; i++) {
        const template = templates[i];
        
        // Update button with progress
        button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Downloading ${template.name} (${i + 1}/${templates.length})...`;
        
        try {
            const response = await fetch('/generate-pdf', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    cv_data: cvData,
                    template: template.id
                })
            });
            
            if (!response.ok) {
                throw new Error(`Failed to generate ${template.name} template`);
            }
            
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `CV_${cvData.personal_info.name.replace(/ /g, '_')}_${template.name}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
            
            // Small delay between downloads to prevent browser blocking
            if (i < templates.length - 1) {
                await new Promise(resolve => setTimeout(resolve, 800));
            }
        } catch (error) {
            console.error(`Error generating ${template.name}:`, error);
            alert(`Failed to generate ${template.name} template. Continuing...`);
        }
    }
    
    // Restore button
    button.disabled = false;
    button.innerHTML = '<i class="fas fa-check"></i> All Templates Downloaded!';
    
    // Reset button after 3 seconds
    setTimeout(() => {
        button.innerHTML = originalHTML;
    }, 3000);
}
    </script>
</body>
</html>